<% presenter = CollectionFilterPresenter.new(@collections, params, cookies) %>
<div class="max-width margin-block-end-half"
		data-controller="dialog" data-action="keydown.esc->dialog#close click@document->dialog#closeOnClickOutside">
	<button class="events__filter-btn input input--select flex-inline center min-width max-width txt-small" data-action="click->dialog#open:stop">
		<span class="overflow-ellipsis center">
			<%= presenter.filter_text %>
		</span>
	</button>

	<dialog class="events__popup popup popup--animated panel flex-column align-start gap-half fill-white shadow"
				style="z-index: 5;" data-dialog-target="dialog" data-action="turbo:before-cache@document->dialog#close">
		<div class="flex align-center full-width gap-half">
			<span class="btn borderless" style="pointer-events: none; --icon-size: 1.3em; --btn-padding: 0 0.4em 0 0.6em;">
				<%= icon_tag "filter" %>
			</span>
			<strong class="popup__title txt-medium">Collections</strong>
			<button class="btn borderless txt-x-small flex-item-justify-end" data-action="click->dialog#close" >
				<%= icon_tag "remove-med" %>
				<span class="for-screen-reader">Close</span>
			</button>
		</div>

		<div class="popup__group flex align-center full-width gap-half overflow-ellipsis">
			<%= link_to new_collection_path, class: "btn popup__new popup__item", style: "view-transition-name: new-collection" do %>
				<%= icon_tag "add" %>
				<span>Add a new collection</span>
			<% end %>
		</div>
		<hr class="full-width separator--horizontal margin-none" style="--border-color: transparent;">

		<%= form_with url: events_path, method: :get, class: "flex flex-column max-width popup__list full-width",
					data: { controller: "form" } do |form| %>
			<%= link_to events_path(clear_filter: true), class: "popup__group flex align-center", style: "--hover-size: 0" do %>
				<div class="btn txt-xx-small flex-item-no-shrink">
					<input type="checkbox" <%= "checked" unless params[:collection_ids] || cookies[:collection_filter] %>>

					<span class="for-screen-reader">
						See everything in all collections
					</span>
					<%= icon_tag "check", size: 18, class: "checked" %>
				</div>
				<%= tag.div class: "btn popup__item min-width flex-item-grow" do %>
					<span class="overflow-ellipsis">All collections</span>
				<% end %>
				<span class="translucent flex-item-no-shrink"> ›</span>
			<% end %>

			<% @collections.each do |collection| %>
				<div class="popup__group flex align-center">
					<div class="btn txt-xx-small">
						<%= form.check_box "collection_ids[]", {
							checked: (params[:collection_ids] || cookies[:collection_filter]&.split(","))&.include?(collection.id.to_s),
							data: { action: "change->form#submit" },
							include_hidden: false,
						}, collection.id %>

						<span class="for-screen-reader">
							Toggle filter for <%= collection.name %>
						</span>
						<%= icon_tag "check", size: 18, class: "checked flex-item-justify-end" %>
					</div>

					<%= link_to cards_path(collection_ids: [ collection ]), class: "btn popup__item min-width flex-item-grow" do %>
						<span class="overflow-ellipsis"><%= collection.name %></span>
					<% end %>
			
					<span class="translucent flex-item-no-shrink"> ›</span>
				</div>
			<% end %>
		<% end %>
	</dialog>
</div>
